<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>OpenID Connect Guide - OpenMPF</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "OpenID Connect Guide";
    var mkdocs_page_input_path = "OpenID-Connect-Guide.md";
    var mkdocs_page_url = "/OpenID-Connect-Guide/index.html";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="icon icon-home"> OpenMPF</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../index.html">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">General</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../Release-Notes/index.html">Release Notes</a>
                </li>
                <li class="">
                    
    <a class="" href="../License-And-Distribution/index.html">License and Distribution</a>
                </li>
                <li class="">
                    
    <a class="" href="../Acknowledgements/index.html">Acknowledgements</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Guides</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../Install-Guide/index.html">Install Guide</a>
                </li>
                <li class="">
                    
    <a class="" href="../Admin-Guide/index.html">Admin Guide</a>
                </li>
                <li class="">
                    
    <a class="" href="../User-Guide/index.html">User Guide</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="index.html">OpenID Connect Guide</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#openid-connect-overview">OpenID Connect Overview</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#configuration">Configuration</a></li>
        
            <li><a class="toctree-l4" href="#example-with-keycloak">Example with Keycloak</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../Media-Segmentation-Guide/index.html">Media Segmentation Guide</a>
                </li>
                <li class="">
                    
    <a class="" href="../Feed-Forward-Guide/index.html">Feed Forward Guide</a>
                </li>
                <li class="">
                    
    <a class="" href="../Derivative-Media-Guide/index.html">Derivative Media Guide</a>
                </li>
                <li class="">
                    
    <a class="" href="../Object-Storage-Guide/index.html">Object Storage Guide</a>
                </li>
                <li class="">
                    
    <a class="" href="../Markup-Guide/index.html">Markup Guide</a>
                </li>
                <li class="">
                    
    <a class="" href="../TiesDb-Guide/index.html">TiesDb Guide</a>
                </li>
                <li class="">
                    
    <a class="" href="../REST-API/index.html">REST API</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Component Development</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../Component-API-Overview/index.html">Component API Overview</a>
                </li>
                <li class="">
                    
    <a class="" href="../Component-Descriptor-Reference/index.html">Component Descriptor Reference</a>
                </li>
                <li class="">
                    
    <a class="" href="../CPP-Batch-Component-API/index.html">C++ Batch Component API</a>
                </li>
                <li class="">
                    
    <a class="" href="../Python-Batch-Component-API/index.html">Python Batch Component API</a>
                </li>
                <li class="">
                    
    <a class="" href="../Java-Batch-Component-API/index.html">Java Batch Component API</a>
                </li>
                <li class="">
                    
    <a class="" href="../GPU-Support-Guide/index.html">GPU Support Guide</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Additional Developer Resources</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../Contributor-Guide/index.html">Contributor Guide</a>
                </li>
                <li class="">
                    
    <a class="" href="../Development-Environment-Guide/index.html">Development Environment Guide</a>
                </li>
                <li class="">
                    
    <a class="" href="../Node-Guide/index.html">Node Guide</a>
                </li>
                <li class="">
                    
    <a class="" href="../Workflow-Manager-Architecture/index.html">Workflow Manager Architecture</a>
                </li>
                <li class="">
                    
    <a class="" href="../CPP-Streaming-Component-API/index.html">C++ Streaming Component API</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">OpenMPF</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      
        
          <li>Guides &raquo;</li>
        
      
    
    <li>OpenID Connect Guide</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p><strong>NOTICE:</strong> This software (or technical data) was produced for the U.S. Government under contract,
and is subject to the Rights in Data-General Clause 52.227-14, Alt. IV (DEC 2007). Copyright 2023
The MITRE Corporation. All Rights Reserved.</p>
<h1 id="openid-connect-overview">OpenID Connect Overview</h1>
<p>Workflow Manager can use an OpenID Connect (OIDC) provider to handle authentication for users of
the web UI and clients of the REST API.</p>
<h2 id="configuration">Configuration</h2>
<p>In order to use OIDC, Workflow Manager must first be registered with OIDC provider. The exact
process for this varies by provider.  As part of the registration process, a client ID and client
secret should be provided. Those values should be set in the <code>OIDC_CLIENT_ID</code> and
<code>OIDC_CLIENT_SECRET</code> environment variables. During the registration process the provider will
likely request a redirect URI. The redirect URI should be set to the base URI for Workflow Manger
with <code>/login/oauth2/code/provider</code> appended.</p>
<p>The documentation for the OIDC provider should specify the base URI a client should use to
authenticate users. The URI should be set in the <code>OIDC_ISSUER_URI</code> environment variable. To verify
the URI is correct, check that the JSON discovery document is returned when sending an HTTP GET
request to the URI with <code>/.well-known/openid-configuration</code> appended.</p>
<p>After a user or REST client authenticates with the OIDC provider, Workflow Manager will check for a
claim with a specific value to determine if the user is authorized to access Workflow Manager and
with what role. The <code>OIDC_USER_CLAIM_NAME</code> and <code>OIDC_ADMIN_CLAIM_NAME</code> environment variables
specify the name of claim that must be present. The <code>OIDC_USER_CLAIM_VALUE</code> and
<code>OIDC_ADMIN_CLAIM_VALUE</code> environment variables specify the required value of the claim.</p>
<h3 id="environment-variables">Environment Variables</h3>
<ul>
<li><code>OIDC_ISSUER_URI</code> (Required): URI for the OIDC provider that will be used to authenticate users
    through the web UI. If <code>OIDC_JWT_ISSUER_URI</code> is not set, <code>OIDC_ISSUER_URI</code> will also be used to
    authenticate REST clients.  The OIDC configuration endpoint must exist at the value of
    <code>OIDC_ISSUER_URI</code> with <code>/.well-known/openid-configuration</code> appended.</li>
<li><code>OIDC_JWT_ISSUER_URI</code> (Optional): Works the same way as <code>OIDC_ISSUER_URI</code>, except that the
    configuration will only be used to authenticate REST clients. When not provided,
    <code>OIDC_ISSUER_URI</code> will be used.</li>
<li><code>OIDC_CLIENT_ID</code> (Required): The client ID that Workflow Manager will use to authenticate with
    the OIDC provider.</li>
<li><code>OIDC_CLIENT_SECRET</code> (Required): The client secret Workflow Manager will use to authenticate
    with the OIDC provider.</li>
<li><code>OIDC_USER_CLAIM_NAME</code> (Optional): Specifies the name of the claim from the authentication token
    that is required for a user or REST client to be granted access to Workflow Manager with the
    <code>USER</code> role.</li>
<li><code>OIDC_USER_CLAIM_VALUE</code> (Optional): Specifies the required value of the claim specified in
    <code>OIDC_USER_CLAIM_NAME</code>. If the claim is a list, only one of the values in the list must match.</li>
<li><code>OIDC_ADMIN_CLAIM_NAME</code> (Optional): Specifies the name of the claim from the authentication token
    that is required for a user or REST client to be granted access to Workflow Manager with the
    <code>ADMIN</code> role.</li>
<li><code>OIDC_ADMIN_CLAIM_VALUE</code> (Optional): Specifies the required value of the claim specified in
    <code>OIDC_ADMIN_CLAIM_NAME</code>. If the claim is a list, only one of the values in the list must match.</li>
<li><code>OIDC_SCOPES</code> (Optional): A comma-separated list the scopes to be requested from the OIDC
    provider when authenticating a user through the web UI. The OIDC specification requires one of
    the scopes to be <code>openid</code>, so if this environment variable is omitted or <code>openid</code> is not in the
    list, it will be automatically added.</li>
<li><code>OIDC_USER_NAME_ATTR</code> (Optional): The name of the claim containing the user name. Defaults to
    <code>sub</code>.</li>
</ul>
<h2 id="example-with-keycloak">Example with Keycloak</h2>
<p>The following example explains how to test Workflow Manager with Keycloak as the OIDC provider.
It is just an example and should not be used in production.</p>
<p>1. Start Keycloak in development mode:</p>
<pre><code class="language-bash">docker run -p 9090:8080 -e KEYCLOAK_ADMIN=admin -e KEYCLOAK_ADMIN_PASSWORD=admin \
    quay.io/keycloak/keycloak:21.1.1 start-dev
</code></pre>
<p>2. Go to <a href="http://localhost:9090/admin">http://localhost:9090/admin</a> in a browser and login with username <code>admin</code> and
    password <code>admin</code>.</p>
<p>3. Create a new realm:</p>
<ul>
<li>Click the dropdown box in the upper left that says "master".</li>
<li>Click "Create Realm".</li>
<li>Enter a realm name.</li>
<li>Click "Create".</li>
<li>Use the realm name you entered to set Workflow Manager's <code>OIDC_ISSUER_URI</code> environment
    variable to: <code>http://localhost:9090/realms/&lt;realm-name&gt;</code></li>
</ul>
<p>4. Create the client Workflow Manager will use to authenticate users:</p>
<ul>
<li>Click "Clients" in the left menu.</li>
<li>Click "Create client".</li>
<li>Make sure "Client type" is "OpenID Connect".</li>
<li>Enter a client ID.</li>
<li>Click "Next".</li>
<li>Enable "Client authentication".</li>
<li>Make sure "Standard flow" is checked.</li>
<li>Click "Next"</li>
<li>In "Valid redirect URIs" enter the base URL for Workflow Manager with
    <code>/login/oauth2/code/provider</code> appended.</li>
<li>In "Valid post logout redirect URIs" enter the base URL for Workflow Manager.</li>
<li>Click "Save"</li>
<li>Set Workflow Manager's <code>OIDC_CLIENT_ID</code> environment variable to the client ID you entered.</li>
<li>On the "Client details" page for the new client go to the "Credentials" tab.</li>
<li>Click the eye icon next to "Client secret".</li>
<li>Set Workflow Manager's <code>OIDC_CLIENT_SECRET</code> environment variable to the value displayed in
    "Client secret".</li>
</ul>
<p>5. Create a Keycloak role that maps to a Workflow Manager role:</p>
<ul>
<li>Click "Realm roles" in the left menu.</li>
<li>Click "Create role".</li>
<li>Enter a "Role name".</li>
<li>Click "Save".</li>
<li>If the Keycloak role should make the user an <code>ADMIN</code> in Workflow Manager, set Workflow
    Manager's <code>OIDC_ADMIN_CLAIM_VALUE</code> to the role name you just entered. If it should be a
    <code>USER</code>, then set the <code>OIDC_USER_CLAIM_VALUE</code> environment variable.</li>
<li>Only one of <code>OIDC_ADMIN_CLAIM_VALUE</code> and <code>OIDC_USER_CLAIM_VALUE</code> need to be set. If you would
    like to set up both roles repeat this step.</li>
</ul>
<p>6. Include the Keycloak role(s) in the access token:</p>
<ul>
<li>Click "Client scopes" in the left menu.</li>
<li>Click "roles".</li>
<li>Click the "Mappers" tab.</li>
<li>Click "Add mapper"</li>
<li>Click "From predefined mappers".</li>
<li>Check "groups".</li>
<li>Click "Add".</li>
<li>The default name "Token Claim Name" is "groups". This can be changed.</li>
<li>If you created an <code>ADMIN</code> role in step 5 set <code>OIDC_ADMIN_CLAIM_NAME</code> to the value in
    "Token Claim Name". If you created a <code>USER</code> role, do the same for <code>OIDC_USER_CLAIM_NAME</code>.</li>
</ul>
<p>7. Optionally, configure Workflow Manager to display the user name instead of the ID.</p>
<ul>
<li>Set Workflow Manager's <code>OIDC_USER_NAME_ATTR</code> environment variable to <code>preferred_username</code>.</li>
</ul>
<p>8. Create users:</p>
<ul>
<li>Click "Users" in the left menu.</li>
<li>Click "Create new user".</li>
<li>Enter a "Username".</li>
<li>Click "Create".</li>
<li>Click the "Credentials" tab.</li>
<li>Click "Set password".</li>
<li>Set a password.</li>
<li>Uncheck "Temporary".</li>
<li>Click "Save".</li>
<li>Click the "Role mapping" tab.</li>
<li>Click "Assign role".</li>
<li>Check one of the roles create in step 5.</li>
<li>Click "Assign".</li>
</ul>
<p>9. You should now be able to start Workflow Manager. When you initially navigate to Workflow
   Manager, you will be redirected to the Keycloak log in page. You can log in using the
   users created in step 8.</p>
<p>10. Add REST clients:</p>
<ul>
<li>Click "Clients" in the left menu.</li>
<li>Click "Create client".</li>
<li>Set a "Client ID".</li>
<li>Click "Next".</li>
<li>Enable "Client authentication".</li>
<li>Enable "Service accounts roles".</li>
<li>Click "Next".</li>
<li>Click "Save".</li>
<li>Click the "Service account roles" tab.</li>
<li>Click "Assign role".</li>
<li>Check a role created in step 5.</li>
<li>Click "Assign".</li>
</ul>
<h3 id="test-rest-authentication">Test REST authentication</h3>
<p>Using the client id/secret from step 10 and the realm name from step 3, run the following command:</p>
<pre><code class="language-bash">curl -d grant_type=client_credentials -u '&lt;client-id&gt;:&lt;client-secret&gt;' 'http://localhost:9090/realms/&lt;realm-name&gt;/protocol/openid-connect/token'
</code></pre>
<p>The response JSON will contain a token in the <code>"access_token"</code> property. That token need to
included as a bearer token in REST requests to Workflow Manager. For example:</p>
<pre><code class="language-bash">curl -H &quot;Authorization: Bearer &lt;access-token&gt;&quot; http://localhost:8080/workflow-manager/rest/jobs/1
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Media-Segmentation-Guide/index.html" class="btn btn-neutral float-right" title="Media Segmentation Guide">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../User-Guide/index.html" class="btn btn-neutral" title="User Guide"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>OpenMPF</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../User-Guide/index.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../Media-Segmentation-Guide/index.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../js/mustache.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
